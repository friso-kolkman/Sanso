
import { motion, AnimatePresence } from 'framer-motion';
import Navigation from '@/components/Navigation';
import ContactForm from '@/components/ContactForm';
import Hero from '@/components/Hero';
import { Button } from '@/components/ui/button';
import { useLanguage } from '@/contexts/LanguageContext';
import { useState, useEffect } from 'react';
import { Brain, Heart, Clock, Shield, Leaf, Droplet, Atom, GitBranch } from 'lucide-react';

const Index = () => {
  const { t } = useLanguage();
  const [expandedCard, setExpandedCard] = useState<number | null>(null);
  const [expandedStep, setExpandedStep] = useState<number | null>(null);
  const [reduceMotion, setReduceMotion] = useState(false);

  // Ensure no card is expanded on mount
  useEffect(() => {
    setExpandedCard(null);
  }, []);

  useEffect(() => {
    const m = window.matchMedia('(prefers-reduced-motion: reduce)');
    setReduceMotion(m.matches);
    const onChange = (e: MediaQueryListEvent) => setReduceMotion(e.matches);
    m.addEventListener('change', onChange);
    return () => m.removeEventListener('change', onChange);
  }, []);

  const steps = [
    {
      id: 1,
      title: 'Settle in',
      caption: 'You relax in a comfortable, pressurized chamber.',
      detail:
        'We guide you into the chamber and slowly raise the pressure up to 2.0 ATA. This feels similar to airplane takeoff or landing — you may notice gentle pressure in your ears, which we help you equalize.',
      icon: Leaf,
      imgAlt: 'Person entering chamber'
    },
    {
      id: 2,
      title: 'Pressure compresses your plasma',
      caption: 'Pressure gently compresses your blood plasma.',
      detail:
        'At higher pressure, gases behave differently. Your blood plasma — the liquid part of your blood — becomes able to carry much more oxygen than it can at normal atmospheric pressure.',
      icon: Droplet,
      imgAlt: 'Stylized blood plasma graphic'
    },
    {
      id: 3,
      title: 'Plasma takes on extra oxygen',
      caption: 'Your plasma absorbs oxygen beyond what hemoglobin normally carries.',
      detail:
        'Normally, nearly all red blood cells are already saturated with oxygen. Under 2.0 ATA, oxygen dissolves directly into plasma, significantly boosting your body’s total oxygen supply.',
      icon: Atom,
      imgAlt: 'Oxygen molecules entering plasma'
    },
    {
      id: 4,
      title: 'Oxygen reaches deeper into tissues',
      caption: 'This oxygen-rich plasma spreads into tissues and capillaries.',
      detail:
        'Because plasma oxygen is not bound like hemoglobin, it diffuses more easily into haarvaatjes (capillaries) and surrounding tissues. This helps oxygen reach areas with limited blood flow, improving healing and reducing hypoxia.',
      icon: GitBranch,
      imgAlt: 'Microvasculature / capillaries'
    },
    {
      id: 5,
      title: 'Return to normal pressure',
      caption: 'We lower the pressure gradually and review your session.',
      detail:
        'After the session, the chamber slowly returns to normal pressure. We check in with you, discuss how you felt, and adapt your plan. Benefits build up over a series of sessions.',
      icon: Clock,
      imgAlt: 'Chamber decompressing'
    }
  ];

  const benefitCards = [
    {
      title: "Verbeterde Cognitieve Functie",
      description: "Beter geheugen, focus en mentale helderheid door optimale zuurstofvoorziening.",
      icon: <Brain className="w-6 h-6" />,
      iconBg: "bg-clay/10 text-clay"
    },
    {
      title: "Hart & Vaten Gezondheid",
      description: "Verbeterde bloedcirculatie en cardiovasculaire functie voor optimale gezondheid.",
      icon: <Heart className="w-6 h-6" />,
      iconBg: "bg-red-100 text-red-600"
    },
    {
      title: "Anti-Aging Voordelen",
      description: "Minder oxidatieve stress, gezondere huid en meer vitaliteit.",
      icon: <Clock className="w-6 h-6" />,
      iconBg: "bg-green-100 text-green-600"
    },
    {
      title: "Immuunsysteem Ondersteuning",
      description: "Sterkere afweer en betere natuurlijke bescherming tegen ziekte.",
      icon: <Shield className="w-6 h-6" />,
      iconBg: "bg-yellow-100 text-yellow-600"
    },
    {
      title: "Levensduur Verlenging",
      description: "Langere gezondheidsspanne door geoptimaliseerde celwerking.",
      icon: <Leaf className="w-6 h-6" />,
      iconBg: "bg-green-700 text-white"
    }
  ];

  const handleCardClick = (index: number) => {
    console.log('Card clicked:', index, 'Current expanded:', expandedCard);
    setExpandedCard(expandedCard === index ? null : index);
  };

  return (
    <div className="min-h-screen bg-sand">
      <Navigation />
      {/* Cinematic Hero Section */}
      <Hero />

      {/* How it works */}
      <section id="how-it-works" className="relative py-16 md:py-20 bg-stone">
        <div className="absolute -top-16 left-0 right-0 h-16 bg-gradient-to-b from-black/20 to-transparent pointer-events-none" />
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
          <motion.h2
            initial={reduceMotion ? false as any : { opacity: 0, y: 12 }}
            whileInView={reduceMotion ? {} : { opacity: 1, y: 0 }}
            viewport={{ once: true, margin: '-50px' }}
            transition={{ duration: 0.5 }}
            className="text-3xl md:text-4xl font-semibold text-center text-ink"
          >
            How it works
          </motion.h2>
          <motion.p
            initial={reduceMotion ? false as any : { opacity: 0, y: 12 }}
            whileInView={reduceMotion ? {} : { opacity: 1, y: 0 }}
            viewport={{ once: true, margin: '-40px' }}
            transition={{ duration: 0.5, delay: 0.05 }}
            className="text-center text-espresso mt-2 mb-10"
          >
            Why HBOT helps your body heal faster
          </motion.p>

          {/* Desktop timeline */}
          <div className="hidden md:block">
            <div className="relative">
              <div className="absolute top-28 left-0 right-0 h-0.5 bg-olive" />
              <div className="grid grid-cols-5 gap-6">
                {steps.map((s, i) => {
                  const Icon = s.icon;
                  return (
                    <motion.div
                      key={s.id}
                      initial={reduceMotion ? false as any : { opacity: 0, y: 16 }}
                      whileInView={reduceMotion ? {} : { opacity: 1, y: 0 }}
                      viewport={{ once: true, margin: '-60px' }}
                      transition={{ duration: 0.5, delay: i * 0.05 }}
                      className="text-center"
                    >
                      <div className="flex justify-center mb-4">
                        <div className="w-[200px] h-[200px] bg-stone rounded-2xl" aria-label={s.imgAlt} />
                      </div>
                      <div className="relative inline-flex items-center justify-center mb-3">
                        <div className="w-10 h-10 rounded-full border-2 border-olive bg-stone flex items-center justify-center text-sm font-semibold text-espresso">
                          {s.id}
                        </div>
                      </div>
                      <div className="flex items-center justify-center gap-2 mb-2 text-espresso">
                        <Icon className="w-5 h-5" />
                        <span className="font-medium">{s.title}</span>
                      </div>
                      <p className="text-espresso text-sm mb-2 max-w-xs mx-auto">{s.caption}</p>
                      <button
                        onClick={() => setExpandedStep(expandedStep === s.id ? null : s.id)}
                        className="text-black/80 hover:text-black underline-offset-4 hover:underline text-sm"
                        aria-expanded={expandedStep === s.id}
                      >
                        Learn more
                      </button>
                      <AnimatePresence>
                        {expandedStep === s.id && (
                          <motion.div
                            initial={{ opacity: 0, height: 0 }}
                            animate={{ opacity: 1, height: 'auto' }}
                            exit={{ opacity: 0, height: 0 }}
                            transition={{ duration: reduceMotion ? 0 : 0.25 }}
                            className="mt-3 text-espresso text-sm max-w-md mx-auto"
                          >
                            {s.detail}
                          </motion.div>
                        )}
                      </AnimatePresence>
                    </motion.div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Mobile stacked timeline */}
          <div className="md:hidden">
            <div className="relative">
              <div className="absolute left-6 top-0 bottom-0 w-0.5 bg-olive" />
              <div className="space-y-10">
                {steps.map((s, i) => {
                  const Icon = s.icon;
                  return (
                    <motion.div
                      key={s.id}
                      initial={reduceMotion ? false as any : { opacity: 0, y: 16 }}
                      whileInView={reduceMotion ? {} : { opacity: 1, y: 0 }}
                      viewport={{ once: true, margin: '-60px' }}
                      transition={{ duration: 0.5, delay: i * 0.05 }}
                      className="relative pl-14"
                    >
                      <div className="mb-3">
                        <div className="w-full flex justify-center">
                          <div className="w-[200px] h-[200px] bg-stone rounded-2xl" aria-label={s.imgAlt} />
                        </div>
                      </div>
                      <div className="absolute left-3 top-[216px] -translate-y-1/2 w-8 h-8 rounded-full bg-stone border-2 border-olive flex items-center justify-center text-xs font-semibold text-espresso">
                        {s.id}
                      </div>
                      <div className="flex items-center gap-3 mb-1 text-espresso">
                        <Icon className="w-5 h-5" />
                        <span className="font-medium">{s.title}</span>
                      </div>
                      <p className="text-espresso text-sm mb-2">{s.caption}</p>
                      <button
                        onClick={() => setExpandedStep(expandedStep === s.id ? null : s.id)}
                        className="text-black/80 hover:text-black underline-offset-4 hover:underline text-sm"
                        aria-expanded={expandedStep === s.id}
                      >
                        Learn more
                      </button>
                      <AnimatePresence>
                        {expandedStep === s.id && (
                          <motion.div
                            initial={{ opacity: 0, height: 0 }}
                            animate={{ opacity: 1, height: 'auto' }}
                            exit={{ opacity: 0, height: 0 }}
                            transition={{ duration: reduceMotion ? 0 : 0.25 }}
                            className="mt-2 text-espresso text-sm"
                          >
                            {s.detail}
                          </motion.div>
                        )}
                      </AnimatePresence>
                    </motion.div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Section CTA */}
          <div className="mt-12 text-center">
            <a href="/pricing" className="inline-flex items-center justify-center px-6 py-3 rounded-md bg-stone text-black hover:bg-stone/90 transition shadow">
              Reservations
            </a>
            <div className="mt-3">
              <a href="/how-it-works" className="text-black/80 hover:text-black underline underline-offset-4">
                Learn more about protocols → /how-it-works
              </a>
            </div>
          </div>
        </div>
      </section>

      {/* HBOT voordelen blok */}
      <section className="py-16 bg-sand">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <motion.h2 
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            className="text-4xl font-normal text-center text-ink mb-12"
          >
            Voordelen
          </motion.h2>
          <motion.p 
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6, delay: 0.2 }}
            className="text-lg text-center text-espresso mb-16"
          >
            Wetenschappelijk bewezen voordelen van HBOT. Bij <span className="font-seasons font-light">SANSŌ</span> richten we ons op echte, meetbare resultaten van hyperbare zuurstoftherapie.
          </motion.p>
          <motion.div className="space-y-4" layout>
            {benefitCards.map((card, index) => (
              <motion.div 
                key={index} 
                layout
                className={`rounded-xl ${index % 2 === 0 ? 'bg-stone' : 'bg-stone'} shadow-md overflow-hidden`}
              >
                <div 
                  className="flex items-center p-6 cursor-pointer"
                  onClick={() => handleCardClick(index)}
                >
                  <div className={`rounded-full p-3 mr-6 ${card.iconBg}`}>
                    {card.icon}
                  </div>
                  <h3 className="text-xl font-normal text-ink flex-grow">
                    {card.title}
                  </h3>
                  <motion.div
                    animate={{ rotate: expandedCard === index ? 180 : 0 }}
                    transition={{ duration: 0.3, ease: "easeInOut" }}
                    className="text-gray-500"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                    </svg>
                  </motion.div>
                </div>
                <AnimatePresence mode="wait">
                  {expandedCard === index && (
                    <motion.div
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: "auto" }}
                      exit={{ opacity: 0, height: 0 }}
                      transition={{ 
                        duration: 0.4, 
                        ease: "easeInOut",
                        height: {
                          duration: 0.4,
                          ease: "easeInOut"
                        }
                      }}
                      className="overflow-hidden"
                    >
                      <div className="px-6 pt-6 pb-6 bg-gray-100">
                        <p className="text-espresso text-base leading-relaxed">
                          {card.description}
                        </p>
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </motion.div>
            ))}
          </motion.div>
        </div>
      </section>

      {/* Nederlandse call-to-action onder de blokken */}
      <section className="py-6 bg-sand">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <p className="text-lg text-center text-espresso mb-3 max-w-2xl mx-auto">
            Ervaar deze voordelen met onze geavanceerde zit-hyperbare kamer, die kan pressuriseren tot 2.0 ATA
          </p>
          <div className="flex justify-center mt-2">
            <Button asChild size="lg" className="bg-black hover:bg-black/90 text-white font-normal px-6 py-2 rounded-md shadow">
              <a href="/pricing">Bekijk prijzen & pakketten</a>
            </Button>
          </div>
        </div>
      </section>

      {/* Contact Section */}
      <section id="contact" className="py-16 bg-stone">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            viewport={{ once: true }}
          >
            <ContactForm />
          </motion.div>
        </div>
      </section>
    </div>
  );
};

export default Index;
